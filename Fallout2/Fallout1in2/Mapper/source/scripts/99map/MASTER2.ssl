/*

   Cathedral - Master's Lair #2

*/

#include "..\headers\define.h"
#include "..\headers\command.h"
#include "..\headers\maps\mstrlr34.h"

#include "..\headers\updatmap.h"

procedure start;
procedure map_enter_p_proc;
procedure map_update_p_proc;

export variable Skill_Used;
export variable Key_Used;
export variable Master_Has_Armed;
export variable Bomb_Armed;
export variable Master_ptr;
export variable signal_mutants;
export variable Master_Has_Activated;

variable mutan_ptr;
variable stuff;

procedure start begin
end

procedure map_enter_p_proc begin
   Darkness;

   if (dude_elevation == 0) then begin
      if (day and not(is_loading_game)) then begin
         if (map_var(MVAR_INVADED) == 0) then begin
            set_map_var(MVAR_INVADED, 1);

            mutan_ptr := create_object_sid(PID_SUPER_NIGHTKIN, 0, 0, SCRIPT_GENMUTAN);
            critter_attempt_placement(mutan_ptr, 20532, 0);
            set_team(mutan_ptr, TEAM_NECROPOLIS_MUTANT);
            stuff := create_object(PID_PLASMA_RIFLE, 0, 0);
            add_obj_to_inven(mutan_ptr, stuff);
            stuff := create_object(PID_MICRO_FUSION_CELL, 0, 0);
            add_obj_to_inven(mutan_ptr, stuff);
            stuff := create_object(PID_STIMPAK, 0, 0);
            add_obj_to_inven(mutan_ptr, stuff);

            mutan_ptr := create_object_sid(PID_SUPER_NIGHTKIN, 0, 0, SCRIPT_GENMUTAN);
            critter_attempt_placement(mutan_ptr, 19337, 0);
            set_team(mutan_ptr, TEAM_NECROPOLIS_MUTANT);
            stuff := create_object(PID_GATLING_LASER, 0, 0);
            add_obj_to_inven(mutan_ptr, stuff);
            stuff := create_object(PID_MICRO_FUSION_CELL, 0, 0);
            add_obj_to_inven(mutan_ptr, stuff);
            stuff := create_object(PID_STIMPAK, 0, 0);
            add_obj_to_inven(mutan_ptr, stuff);

            mutan_ptr := create_object_sid(PID_SUPER_NIGHTKIN, 0, 0, SCRIPT_GENMUTAN);
            critter_attempt_placement(mutan_ptr, 18740, 0);
            set_team(mutan_ptr, TEAM_NECROPOLIS_MUTANT);
            stuff := create_object(PID_GATLING_LASER, 0, 0);
            add_obj_to_inven(mutan_ptr, stuff);
            stuff := create_object(PID_MICRO_FUSION_CELL, 0, 0);
            add_obj_to_inven(mutan_ptr, stuff);
            stuff := create_object(PID_STIMPAK, 0, 0);
            add_obj_to_inven(mutan_ptr, stuff);

            mutan_ptr := create_object_sid(PID_SUPER_NIGHTKIN, 0, 0, SCRIPT_GENMUTAN);
            critter_attempt_placement(mutan_ptr, 21339, 0);
            set_team(mutan_ptr, TEAM_NECROPOLIS_MUTANT);
            stuff := create_object(PID_GATLING_LASER, 0, 0);
            add_obj_to_inven(mutan_ptr, stuff);
            stuff := create_object(PID_MICRO_FUSION_CELL, 0, 0);
            add_obj_to_inven(mutan_ptr, stuff);
            stuff := create_object(PID_STIMPAK, 0, 0);
            add_obj_to_inven(mutan_ptr, stuff);
         end
      end
   end

   if (global_var(GVAR_LOAD_MAP_INDEX) == 2) then begin
      override_map_start(112, 84, 0, 3);
   end
   else if (global_var(GVAR_LOAD_MAP_INDEX) == 3) then begin
      override_map_start(140, 78, 1, 4);
   end
   else if (global_var(GVAR_LOAD_MAP_INDEX) == 5) then begin
      override_map_start(140, 78, 0, 4);
   end
   else if (global_var(GVAR_LOAD_MAP_INDEX) == 12) then begin
      override_map_start(55, 68, 0, 5);
      if (not(is_loading_game) and (global_var(GVAR_MORPHEUS_DELIVERS_PLAYER) == 100)) then begin
         set_global_var(GVAR_MORPHEUS_DELIVERS_PLAYER, 1);
         create_object_sid(PID_MORPHEUS, 13854, 0, SCRIPT_MORPH);

         mutan_ptr := create_object_sid(PID_MASTER_NIGHTKIN, 0, 0, SCRIPT_GENMUTAN);
         critter_attempt_placement(mutan_ptr, 15468, 0);
         set_team(mutan_ptr, TEAM_MASTER_LAIR);
         stuff := create_object(PID_PLASMA_RIFLE, 0, 0);
         add_obj_to_inven(mutan_ptr, stuff);
         stuff := create_object(PID_MICRO_FUSION_CELL, 0, 0);
         add_obj_to_inven(mutan_ptr, stuff);
         stuff := create_object(PID_STIMPAK, 0, 0);
         add_obj_to_inven(mutan_ptr, stuff);

         mutan_ptr := create_object_sid(PID_MASTER_NIGHTKIN, 0, 0, SCRIPT_GENMUTAN);
         critter_attempt_placement(mutan_ptr, 15450, 0);
         set_team(mutan_ptr, TEAM_MASTER_LAIR);
         stuff := create_object(PID_PLASMA_RIFLE, 0, 0);
         add_obj_to_inven(mutan_ptr, stuff);
         stuff := create_object(PID_MICRO_FUSION_CELL, 0, 0);
         add_obj_to_inven(mutan_ptr, stuff);
         stuff := create_object(PID_STIMPAK, 0, 0);
         add_obj_to_inven(mutan_ptr, stuff);
      end
   end
   else begin
      override_map_start(112, 84, 0, 3);
   end

   set_global_var(GVAR_LOAD_MAP_INDEX, 0);
end

procedure map_update_p_proc begin
   Darkness;
end
