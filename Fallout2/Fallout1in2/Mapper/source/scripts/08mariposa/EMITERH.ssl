/*

   Military Base - Force Field

*/

#include "..\headers\define.h"
#include "..\headers\mbase.h"
//#include "..\headers\maps\mbstrg12.h"

#define NAME                    SCRIPT_EMITERH

#include "..\headers\command.h"

procedure start;
procedure use_p_proc;
procedure use_obj_on_p_proc;
procedure use_skill_on_p_proc;
procedure damage_p_proc;

import variable FieldH_Ptr;


procedure start begin
end

procedure use_p_proc begin
   script_overrides;
   display_msg(message_str(SCRIPT_EMITER1A, 100));
end

procedure use_obj_on_p_proc begin
   variable LVar0 := 0;
   LVar0 := obj_pid(obj_being_used_with);
   if (local_var(0) == 0) then begin
      if (LVar0 == 75) then begin
         script_overrides;
         if (is_success(roll_vs_skill(dude_obj, SKILL_REPAIR, 0))) then begin
            if (map_var(18) == 1) then begin
               if not(is_loading_game) then begin  set_obj_invisible(FieldH_Ptr);   end
               display_msg(message_str(SCRIPT_EMITER1A, 103));
               give_exp_points(50);
               display_msg(message_str(SCRIPT_GENCHAT, 103) + "50" + message_str(SCRIPT_GENCHAT, 104));
               set_map_var(18, 0);
            end
            else begin
               if not(is_loading_game) then begin  set_obj_visible(FieldH_Ptr);  end
               display_msg(message_str(SCRIPT_EMITER1A, 105));
               set_map_var(18, 1);
            end
         end
         else begin
            display_msg(message_str(SCRIPT_EMITER1A, 104));
         end
      end
   end
end

procedure use_skill_on_p_proc
begin
   if (local_var(0) == 0) then begin
      if (action_being_used == SKILL_REPAIR) then begin//-- REPAIR
         script_overrides;
         if (is_success(roll_vs_skill(dude_obj, SKILL_REPAIR, -20))) then begin
            if (map_var(18) == 1) then begin
               display_msg(message_str(SCRIPT_EMITER1A, 103));
               if not(is_loading_game) then begin  set_obj_invisible(FieldH_Ptr);   end
               give_exp_points(50);
               display_msg(message_str(SCRIPT_GENCHAT, 103) + "50" + message_str(SCRIPT_GENCHAT, 104));
               set_map_var(18, 0);
            end
            else begin
               if not(is_loading_game) then begin  set_obj_visible(FieldH_Ptr);  end
               display_msg(message_str(SCRIPT_EMITER1A, 105));
               set_map_var(18, 1);
            end
         end
         else begin
            display_msg(message_str(SCRIPT_EMITER1A, 104));
         end
      end
   end
end

procedure damage_p_proc
begin
   set_local_var(0, 1);
   if (FieldH_Ptr != 0) then begin
      FieldH_Ptr := 0;
   end
   if (global_var(GVAR_MRHANDYC_NO_DESTROY_MSG) == 0) then begin
      display_msg(message_str(SCRIPT_EMITER1A, 102));
   end
   else begin
      set_global_var(GVAR_MRHANDYC_NO_DESTROY_MSG, 0);
   end
end
