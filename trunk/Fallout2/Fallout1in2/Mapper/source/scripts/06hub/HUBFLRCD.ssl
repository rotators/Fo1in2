/*

	Hub - Flower child

*/

#include "..\headers\define.h"

#define NAME                    SCRIPT_HUBFLRCD
#define TOWN_REP_VAR            (GVAR_TOWN_REP_HUB)

#include "..\headers\command.h"
#include "..\headers\modreact.h"

procedure start;
procedure combat;
procedure critter_p_proc;
procedure pickup_p_proc;
procedure talk_p_proc;
procedure destroy_p_proc;
procedure look_at_p_proc;
procedure damage_p_proc;

procedure Flower00;
procedure Flower01;
procedure Flower02;
procedure Flower03;
procedure Flower03a;
procedure Flower04;
procedure Flower04a;
procedure Flower05;
procedure Flower05a;
procedure Flower06;
procedure Flower07;
procedure Flower08;
procedure Flower09;
procedure Flower10;
procedure Flower11;
procedure Flower12;
procedure Flower13;
procedure Flower14;

variable tmp_hostile;
variable Only_Once := 1;

procedure start begin
	if Only_Once then begin
		Only_Once := 0;
		set_self_team(TEAM_HUB_CATHEDRAL );
		set_self_ai( AI_LITTLE_KIDS );
	end
end

procedure combat begin
	tmp_hostile := 1;
end

procedure critter_p_proc begin
	if (tmp_hostile) then begin
		tmp_hostile := 0;
		attack(dude_obj);
	end
	if ((map_var(6) == 1) and (self_can_see_dude)) then begin
		critter_set_flee_state(self_obj, 1);
	end
end

procedure pickup_p_proc begin
	if (source_obj == dude_obj) then begin
		tmp_hostile := 1;
	end
end

procedure talk_p_proc begin
	dude_look_at_self;
	get_reaction
	if ((global_var( GVAR_CATHEDRAL_ENEMY ) == 1) or (map_var(0) == 1)) then begin
		call Flower00;
	end
	else begin
		if has_rep_childkiller then begin
			call Flower01;
		end
		else begin
			if (dude_item_count( PID_FLOWER ) == 1) then begin
				float_msg( self_obj, message_str(SCRIPT_HUBFLRCD, 114), FLOAT_MSG_RED );
			end
			else begin
				start_gdialog(588, self_obj, 4, -1, -1);
				gsay_start;
				call Flower02;
				gsay_end;
				end_dialogue;
			end
		end
	end
end

procedure destroy_p_proc begin
	inc_good_critter
	inc_childkiller
end

procedure look_at_p_proc begin
	script_overrides;
	display_msg(message_str(SCRIPT_HUBFLRCD, 100));
end

procedure damage_p_proc
begin
	if party_member_obj(obj_pid(source_obj)) then begin
		set_map_var(6, 1);
	end
end

procedure Flower00 begin
	call flee_dude;
	float_msg( self_obj, message_str(SCRIPT_HUBFLRCD, 101), FLOAT_MSG_RED );
end

procedure Flower01 begin
	call flee_dude;
	float_msg( self_obj, message_str(SCRIPT_HUBFLRCD, 102), FLOAT_MSG_RED );
end

procedure Flower02
begin
	if (dude_is_male) then begin
		gsay_reply( SCRIPT_HUBFLRCD, 103 );
	end
	else begin
		gsay_reply( SCRIPT_HUBFLRCD, 104 );
	end
	NOption( 106, Flower03, 7 );
	NOption( 107, Flower04, 7 );
	NOption( 108, Flower05, 4 );
	GOption( 109, Flower06, 4 );
	BOption( 110, Flower07, 4 );
	BOption( 111, Flower07, 4 );
	GOption( 112, Flower08, -3 );
	BOption( 113, Flower09, -3 );
end

procedure Flower03
begin
	gsay_reply( SCRIPT_HUBFLRCD, 115 );
	GOption( 116, Flower03a, 7 );
	NOption( 107, Flower04, 7 );
	GOption( 109, Flower06, 4 );
	BOption( 110, Flower07, 4 );
	BOption( 119, Flower07, 4 );
end

procedure Flower03a
begin
	if (is_success(roll_vs_skill(dude_obj, SKILL_SPEECH, 20)) == 1) then begin
		call Flower10;
	end
	else begin
		call Flower11;
	end
end

procedure Flower04
begin
	gsay_reply( SCRIPT_HUBFLRCD, 121 );
	NOption( 123, Flower12, 7 );
	GOption( 124, Flower04a, 7 );
	NOption( 125, Flower05, 4 );
	GOption( 126, Flower06, 4 );
	BOption( 110, Flower07, 4 );
	BOption( 119, Flower07, 4 );
end

procedure Flower04a
begin
	if (is_success(roll_vs_skill(dude_obj, SKILL_SPEECH, 0)) == 1) then begin
		call Flower13;
	end
	else begin
		call Flower11;
	end
end

procedure Flower05
begin
	gsay_reply( SCRIPT_HUBFLRCD, 129 );
	GOption( 130, Flower05a, 7 );
	GOption( 131, Flower04a, 7 );
	GOption( 132, Flower06, 4 );
	BOption( 110, Flower07, 4 );
	BOption( 119, Flower07, 4 );
end

procedure Flower05a
begin
	if (is_success(roll_vs_skill(dude_obj, SKILL_SPEECH, 0)) == 1) then begin
		call Flower14;
	end
	else begin
		call Flower11;
	end
end

procedure Flower06
begin
	variable LVar0 := 0;
	LVar0 := create_object( PID_FLOWER, 0, 0 );
	add_obj_to_inven(dude_obj, LVar0);
	gsay_message( SCRIPT_HUBFLRCD, 135, 49 );
end

procedure Flower07 begin
	call flee_dude;
	gsay_message( SCRIPT_HUBFLRCD, 136, 51 );
end

procedure Flower08
begin
	variable LVar0 := 0;
	LVar0 := create_object( PID_FLOWER, 0, 0 );
	add_obj_to_inven(dude_obj, LVar0);
	gsay_message( SCRIPT_HUBFLRCD, 137, 49 );
end

procedure Flower09 begin
	call flee_dude;
	gsay_message( SCRIPT_HUBFLRCD, 138, 51 );
end

procedure Flower10
begin
	variable LVar0 := 0;
	LVar0 := create_object( PID_FLOWER, 0, 0 );
	add_obj_to_inven(dude_obj, LVar0);
	gsay_message( SCRIPT_HUBFLRCD, 139, 49 );
end

procedure Flower11 begin
	call flee_dude;
	gsay_message( SCRIPT_HUBFLRCD, 140, 51 );
end

procedure Flower12
begin
	gsay_reply( SCRIPT_HUBFLRCD, 141 );
	NOption( 142, Flower05a, 7 );
	NOption( 143, Flower04a, 7 );
	GOption( 144, Flower06, 4 );
	BOption( 145, Flower07, 4 );
	BOption( 146, Flower07, 4 );
end

procedure Flower13
begin
	gsay_reply( SCRIPT_HUBFLRCD, 147 );
	NOption( 148, Flower11, 7 );
	GOption( 149, Flower06, 4 );
	BOption( 150, Flower07, 4 );
	BOption( 151, Flower07, 4 );
end

procedure Flower14
begin
	set_global_var( GVAR_DESTROY_VATS_9, 1 );
	gsay_reply( SCRIPT_HUBFLRCD, 152 );
	NOption( 153, Flower11, 7 );
	GOption( 154, Flower06, 4 );
	BOption( 155, Flower07, 4 );
	BOption( 151, Flower07, 4 );
end
