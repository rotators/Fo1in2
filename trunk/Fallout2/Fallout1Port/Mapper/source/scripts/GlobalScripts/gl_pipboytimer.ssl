/*

   Adds Fallout 1 water chip note to the pipboy screen.
   Also other shit related to the counter

	TODO: Rework how the time gets calculated.
	The current version doesn't start at 00:00 but whenever the player has started the game (e.g. 03:00,...).

*/

/* Include Files */
#include "..\headers\command.h"
#include "..\headers\define.h"
#include "..\headers\Sfall\sfall.h"
#include "..\headers\Sfall\dik.h"

/* Standard Script Procedures */
procedure start;

procedure KeyPressHandler;
procedure show_note;
procedure show_days;
procedure delete_all;

#define Scr_Width      get_ini_setting("f2_res.ini|MAIN|SCR_WIDTH")
#define Scr_Heigh      get_ini_setting("f2_res.ini|MAIN|SCR_HEIGHT")

#define timer_active    ((global_var(QUEST_VAULT13_4_WATERCHIP) < 2) and (global_var(VAULT13_WATER_DAYS_LEFT) > 0))

variable lastDay;

procedure start begin

   if (timer_active) then begin

   	if (game_loaded) then begin
   		set_global_script_repeat(5);
   		set_global_script_type(1);
      end

      // Show the pipboy note if the remaining water timer is > 0 days:
   	if ((get_game_mode == PIPBOY) and (get_water_days_left > 0)) then begin
         if (get_sfall_global_int("opennote") != 1) then begin
   	      set_sfall_global("opennote", 1);
            call show_note;

            lastDay := get_water_days_left;
         end
      end
      else begin
         if (get_sfall_global_int("opennote") != 0) then begin
            set_sfall_global("opennote", 0);
            call delete_all;
         end
      end

		lastDay := get_water_days_left;

		/*if (get_game_mode == PIPBOY) then begin
			//debug("last day: " + lastDay);
			if (lastDay < get_water_days_left) then begin
				lastDay := get_water_days_left;
				//debug("new day: " + lastDay);
            DeleteWin("win_days");
            call show_days;
         end
		end*/

		if (game_time > get_sfall_global_int("lastchek")) then begin
         set_sfall_global("lastchek", game_time + ONE_GAME_DAY);

         if (get_game_mode == PIPBOY) then begin
            DeleteWin("win_days");
            call show_days;
         end


      end

		// Game over if the timer has run out:
		//debug("water days left: " + get_water_days_left);
		if (get_water_days_left <= 0) then begin
			play_gmovie(BOIL3_MOVIE);
			signal_end_game;
		end

   end
end

procedure show_note begin
      create_win("win_note_top", ((Scr_Width/2)-288), ((Scr_Heigh/2)-207), 148, 97);
      SelectWin("win_note_top");
      Display("PCX/pip2_top.pcx");
      ShowWin;

      create_win("win_note_bottom", ((Scr_Width/2)-288), ((Scr_Heigh/2)-91), 148, 111);
      SelectWin("win_note_bottom");
      Display("PCX/pip2_bottom.pcx");
      ShowWin;

      create_win("win_note_daysbg", ((Scr_Width/2)-253), ((Scr_Heigh/2)-110), 40, 19);
      SelectWin("win_note_daysbg");
      Display("PCX/pip2_daysbg.pcx");
      ShowWin;

      create_win("win_note_left", ((Scr_Width/2)-288), ((Scr_Heigh/2)-110), 39, 19);
      SelectWin("win_note_left");
      Display("PCX/pip2_left.pcx");
      ShowWin;

      create_win("win_note_right", ((Scr_Width/2)-213), ((Scr_Heigh/2)-110), 73, 19);
      SelectWin("win_note_right");
      Display("PCX/pip2_right.pcx");
      ShowWin;

      call show_days;
end

procedure show_days begin
variable test := (global_var(VAULT13_WATER_DAYS_LEFT) - (GAME_TIME_IN_DAYS - global_var(VAULT13_WATER_DAYS_COUNTER) / (GAME_TIME_SUBSECOND_RESOLUTION * 60 * 60 * 24)));

   // We only have 250 images, so bigger than that can't be shown:
   // YES I KNOW THESE ARE 250 IMAGES, BUT IF YOU WANT IT TO LOOK EXACTLY
   // THE SAME AS IN FALLOUT 1, IT IS A NECESSARY THING TO DO. Sue me.
   if (get_water_days_left <= 250) then begin
      create_win("win_days", ((Scr_Width/2)-253), ((Scr_Heigh/2)-110), 40, 19);
      SelectWin("win_days");
      Display("PCX/days/"+ get_water_days_left +".pcx");
      ShowWin;
   end
end

procedure delete_all begin
   DeleteWin("win_note_top");
   DeleteWin("win_note_bottom");
   DeleteWin("win_note_daysbg");
   DeleteWin("win_note_left");
   DeleteWin("win_note_right");
   DeleteWin("win_days");
end